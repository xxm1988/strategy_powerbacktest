<!DOCTYPE html>
<html>
  <head>
    <title>Multi-Symbol Backtest Report</title>
    <!-- Core Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Tabler UI Core -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>

    <!-- Styling -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />

    <!-- AG Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css"
    />

    <!-- Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Search & Filter Libraries -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <style>
      body {
          font-family: 'Inter', sans-serif;
          background-color: #f8f9fa;
          color: #2c3e50;
          padding: 2rem;
      }

      .strategy-overview {
          background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
          color: white;
          padding: 2.5rem;
          border-radius: 1.5rem;
          margin-bottom: 3rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          position: relative;
          overflow: hidden;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .strategy-overview:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      }

      .strategy-overview::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
          transform: rotate(45deg);
          transition: opacity 0.3s ease;
      }

      .strategy-overview:hover::before {
          opacity: 0.2;
      }

      .dashboard-header {
          background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
          color: white;
          padding: 2rem;
          margin-bottom: 2rem;
          border-radius: 0 0 1rem 1rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .strategy-title {
          font-size: 1.5rem;
          font-weight: 700;
          margin-bottom: 1rem;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      }

      .strategy-description {
          font-size: 1rem;
          line-height: 1.5;
          opacity: 0.9;
      }

      .strategy-metrics {
          display: flex;
          justify-content: space-between;
          margin-top: 2rem;
      }

      .metric {
          text-align: center;
          flex: 1;
          padding: 1rem;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 0.5rem;
          margin: 0 0.5rem;
          transition: background 0.3s ease;
      }

      .metric:hover {
          background: rgba(255, 255, 255, 0.2);
      }

      .metric-title {
          font-size: 0.9rem;
          font-weight: 500;
          margin-bottom: 0.5rem;
      }

      .metric-value {
          font-size: 1.2rem;
          font-weight: 600;
      }

      .overview-metrics {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1.5rem;
          margin-top: 2rem;
      }

      .metric-card {
          background: rgba(255,255,255,0.1);
          padding: 1.5rem;
          border-radius: 1rem;
          backdrop-filter: blur(10px);
      }

      .metric-title {
          font-size: 0.9rem;
          opacity: 0.9;
          margin-bottom: 0.5rem;
      }

      .metric-value {
          font-size: 1.5rem;
          font-weight: 600;
      }

      .symbol-section {
          background: white;
          border-radius: 1.5rem;
          padding: 2rem;
          margin-bottom: 2rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }

      .chart-container {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          margin-bottom: 2rem;
      }

      .correlation-matrix {
          background: white;
          border-radius: 1rem;
          padding: 2rem;
          margin: 2rem 0;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }

      #correlationMatrix {
          min-height: 400px;
          margin: 1rem 0;
      }

      .badge {
          padding: 0.5rem 1rem;
          border-radius: 2rem;
          font-weight: 500;
      }

      .badge-success {
          background-color: #2ecc71;
          color: white;
      }

      .badge-danger {
          background-color: #e74c3c;
          color: white;
      }

      .badge-buy {
          background-color: #2ecc71;
          color: white;
      }

      .badge-sell {
          background-color: #e74c3c;
          color: white;
      }

      .positive { color: #2ecc71; }
      .negative { color: #e74c3c; }

      table.dataTable {
          border-radius: 1rem;
          overflow: hidden;
      }

      .dataTables_wrapper .row {
          margin: 1rem 0;
      }

      .metrics-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
      }

      .metric-group {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
          transition: transform 0.2s;
      }

      .metric-group:hover {
          transform: translateY(-5px);
      }

      .metric-group h3 {
          color: #2c3e50;
          font-size: 1.2rem;
          font-weight: 600;
          margin-bottom: 1rem;
          padding-bottom: 0.5rem;
          border-bottom: 2px solid #e9ecef;
      }

      .metric-group h3 i {
          margin-right: 0.5rem;
          opacity: 0.8;
      }

      .metric-card {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem;
          margin-bottom: 0.5rem;
          border-radius: 0.5rem;
          background: #f8f9fa;
          transition: background-color 0.2s;
      }

      .metric-card:hover {
          background: #e9ecef;
      }

      .charts-grid {
          margin-top: 2rem;
      }

      .symbol-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 2rem;
          padding-bottom: 1rem;
          border-bottom: 2px solid #e9ecef;
      }

      .symbol-title {
          margin: 0;
          font-size: 1.5rem;
          font-weight: 600;
      }

      .symbol-metrics {
          margin-left: auto;
      }

      .trades-section {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          margin-top: 2rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .trades-section h3 {
          color: #2c3e50;
          font-size: 1.2rem;
          font-weight: 600;
          margin-bottom: 1.5rem;
      }

      .trades-section h3 i {
          margin-right: 0.5rem;
          opacity: 0.8;
      }

      .badge-buy {
          background-color: #2ecc71;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 2rem;
          font-weight: 500;
      }

      .badge-sell {
          background-color: #e74c3c;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 2rem;
          font-weight: 500;
      }

      .table {
          margin-bottom: 0;
      }

      .table thead th {
          border-bottom: 2px solid #e9ecef;
          font-weight: 600;
          color: #2c3e50;
      }

      .table td {
          vertical-align: middle;
      }

      .positive {
          color: #2ecc71;
          font-weight: 500;
      }

      .negative {
          color: #e74c3c;
          font-weight: 500;
      }

      /* DataTables customization */
      .dataTables_wrapper .dataTables_length select {
          border-radius: 0.5rem;
          padding: 0.375rem 1.75rem 0.375rem 0.75rem;
      }

      .dataTables_wrapper .dataTables_filter input {
          border-radius: 0.5rem;
          padding: 0.375rem 0.75rem;
      }

      .dataTables_wrapper .dataTables_info {
          color: #6c757d;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button {
          border-radius: 0.5rem;
          margin: 0 0.2rem;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
          background: #3498db;
          border-color: #3498db;
          color: white !important;
      }

      .trades-table {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          margin-top: 1.5rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .positive {
          color: #00c853;
          font-weight: 600;
      }

      .negative {
          color: #ff1744;
          font-weight: 600;
      }

      .metrics-dashboard {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 1.5rem;
          margin-bottom: 2rem;
      }

      .metric-card-large {
          grid-column: 1 / -1;
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      }

      .metric-card-medium {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      }

      .metric-header {
          margin-bottom: 1.5rem;
          padding-bottom: 0.75rem;
          border-bottom: 1px solid #e9ecef;
      }

      .metric-header h3 {
          font-size: 1.1rem;
          font-weight: 600;
          color: #2c3e50;
          margin: 0;
      }

      .metric-header h3 i {
          margin-right: 0.5rem;
          opacity: 0.8;
      }

      .performance-highlights {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 2rem;
          margin-bottom: 2rem;
      }

      .highlight-stats {
          display: grid;
          gap: 1rem;
      }

      .stat-item {
          padding: 1rem;
          background: #f8f9fa;
          border-radius: 0.75rem;
          transition: transform 0.2s;
      }

      .stat-item:hover {
          transform: translateY(-2px);
          background: #e9ecef;
      }

      .stat-label {
          font-size: 0.875rem;
          color: #6c757d;
          margin-bottom: 0.5rem;
      }

      .stat-value {
          font-size: 1.25rem;
          font-weight: 600;
      }

      .trading-stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 1rem;
      }

      .stat-box {
          display: flex;
          align-items: center;
          padding: 1rem;
          background: #f8f9fa;
          border-radius: 0.75rem;
          transition: all 0.2s;
      }

      .stat-box:hover {
          transform: translateY(-2px);
          background: #e9ecef;
      }

      .stat-icon {
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: white;
          border-radius: 50%;
          margin-right: 1rem;
      }

      .stat-icon i {
          font-size: 1.25rem;
          color: #3498db;
      }

      .risk-details {
          margin-top: 1.5rem;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
      }

      .detail-item {
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 0.75rem;
          transition: transform 0.2s;
      }

      .detail-item:hover {
          transform: translateY(-2px);
          background: #e9ecef;
      }

      .detail-label {
          display: block;
          font-size: 0.875rem;
          color: #6c757d;
          margin-bottom: 0.5rem;
      }

      .detail-value {
          display: block;
          font-size: 1.125rem;
          font-weight: 600;
      }

      /* Adjust radar chart container */
      #riskRadar-{{ symbol }} {
          height: 300px;
          margin: 0 auto;
      }

      /* Risk metrics card specific adjustments */
      .metric-card-medium .metric-content {
          display: flex;
          flex-direction: column;
          gap: 1.5rem;
      }

      .correlation-matrix {
          background: white;
          border-radius: 1rem;
          padding: 2rem;
          margin: 2rem 0;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }

      #correlationMatrix {
          min-height: 400px;
          margin: 1rem 0;
      }

      .page-pretitle {
          font-size: 0.825rem;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          color: #656d77;
          margin-bottom: 0.25rem;
      }

      .page-title {
          margin: 0;
          font-size: 1.65rem;
          line-height: 1.5rem;
          font-weight: 600;
          color: #1e293b;
          word-break: break-word;
      }

      .card {
          transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      .metric-overview {
          transition: all 0.3s ease;
          border: none;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .metric-overview:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      }

      .metric-icon {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          background: #f8f9fa;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 1rem;
      }

      .metric-icon i {
          font-size: 1.2rem;
          color: #3498db;
      }

      .analysis-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
          margin-bottom: 2rem;
      }

      .chart-card {
          background: white;
          border-radius: 1rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
          overflow: hidden;
          transition: all 0.3s ease;
      }

      .chart-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      }

      .card-header {
          padding: 1.25rem;
          border-bottom: 1px solid #e9ecef;
          background: white;
      }

      .card-header h3 {
          margin: 0;
          font-size: 1.1rem;
          font-weight: 600;
          color: #2c3e50;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .chart-container {
          padding: 1.5rem;
          height: 400px;
      }

      @media (max-width: 992px) {
          .analysis-grid {
              grid-template-columns: 1fr;
          }
      }

      /* Add to your existing styles */
      .nav-tabs .nav-link {
          color: #1e293b;
          border: none;
          padding: 1rem 1.5rem;
      }

      .nav-tabs .nav-link.active {
          color: #206bc4;
          border-bottom: 2px solid #206bc4;
          background: transparent;
      }

      .nav-tabs .nav-link:hover:not(.active) {
          border-bottom: 2px solid #e9ecef;
      }

      .card {
          margin-bottom: 1.5rem;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .badge {
          padding: 0.25rem 0.75rem;
      }

      .bg-green {
          background: #2fb344;
      }

      .bg-red {
          background: #d63939;
      }

      .page-body {
          padding: 2rem 0;
      }

      .container-xl {
          max-width: 1320px;
          margin: 0 auto;
          padding-left: 1.5rem;
          padding-right: 1.5rem;
      }

      .symbol-header {
          border-bottom: 1px solid #e9ecef;
          padding-bottom: 1.5rem;
      }

      .select2-container {
          width: 100% !important;
      }

      .select2-container .select2-selection--multiple {
          min-height: 38px;
          border: 1px solid #dee2e6;
          border-radius: 4px;
      }

      .select2-container .select2-search__field {
          margin-top: 7px;
      }

      .select2-container .select2-selection__choice {
          background-color: #206bc4;
          color: white;
          border: none;
          border-radius: 3px;
          padding: 2px 8px;
          margin: 5px 5px 0;
      }

      .select2-container .select2-selection__choice__remove {
          color: white;
          margin-right: 5px;
      }

      .noUi-connect {
          background: #206bc4;
      }

      .filtered-out {
          display: none;
      }

      .symbol-section {
          transition: opacity 0.3s ease;
      }

      .symbol-section.filtered {
          opacity: 0.5;
          pointer-events: none;
      }

      /* Enhanced Filter Styles */
      .select2-container .select2-selection--multiple {
          min-height: 42px;
          border: 1px solid rgba(98, 105, 118, 0.4) !important;
          border-radius: 8px;
          background-color: #fff;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
      }

      .select2-container .select2-selection--multiple:hover {
          border-color: rgba(32, 107, 196, 0.4) !important;
      }

      .select2-container--default.select2-container--focus .select2-selection--multiple {
          border-color: rgba(32, 107, 196, 0.4) !important;
          box-shadow: 0 0 0 4px rgba(32, 107, 196, 0.4);
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice {
          background: rgba(59, 130, 246, 0.4);
          color: #000;
          border: none;
          border-radius: 6px;
          padding: 4px 10px;
          margin: 4px;
          font-size: 0.875rem;
          font-weight: 500;
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice:hover {
          background: rgba(79, 70, 229, 0.4);
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
          color: #000;
          opacity: 0.4;
          margin-right: 6px;
          border: none;
          padding: 0 4px;
          border-radius: 4px;
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
          background: rgba(0, 0, 0, 0.4);
          color: #000;
      }

      .select2-dropdown {
          border: 1px solid rgba(98, 105, 118, 0.4);
          border-radius: 8px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }

      .select2-container--default .select2-results__option--highlighted[aria-selected] {
          background: rgba(59, 130, 246, 0.4);
          color: #000;
      }

      .select2-container--default .select2-results__option[aria-selected=true] {
          background-color: rgba(37, 99, 235, 0.4);
          color: #000;
      }

      .select2-container--default .select2-search--inline .select2-search__field {
          color: #000;
          opacity: 0.8;
      }

      .active-filters {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
      }

      .filter-badge {
          display: inline-flex;
          align-items: center;
          padding: 0.25rem 0.75rem;
          background: rgba(32, 107, 196, 0.1);
          color: #206bc4;
          border-radius: 100px;
          font-size: 0.875rem;
      }

      .filter-badge .ti {
          margin-right: 0.5rem;
      }

      .filter-badge .remove-filter {
          margin-left: 0.5rem;
          cursor: pointer;
          opacity: 0.7;
      }

      .filter-badge .remove-filter:hover {
          opacity: 1;
      }

      .input-icon {
          position: relative;
      }

      .input-icon .input-icon-addon {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 2.5rem;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #626976;
          z-index: 1;
      }

      .input-icon .form-select,
      .input-icon .form-control {
          padding-left: 2.5rem;
      }

      /* Filter Card Styles */
      .filter-card {
          background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
          border: none;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03), 0 6px 24px rgba(0, 0, 0, 0.02);
          border-radius: 16px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          margin: 1.5rem 0;
          backdrop-filter: blur(10px);
      }

      .filter-card:hover {
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 12px 28px rgba(0, 0, 0, 0.03);
          transform: translateY(-2px);
      }

      /* Select2 Enhancements */
      .select2-container .select2-selection--multiple {
          min-height: 48px;
          background: rgba(255, 255, 255, 0.8);
          border: 1px solid rgba(148, 163, 184, 0.2) !important;
          border-radius: 12px;
          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
          backdrop-filter: blur(8px);
      }

      .select2-container .select2-selection--multiple:hover {
          background: rgba(255, 255, 255, 0.95);
          border-color: rgba(59, 130, 246, 0.4) !important;
      }

      .select2-container--default.select2-container--focus .select2-selection--multiple {
          border-color: rgb(59, 130, 246) !important;
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
          background: #ffffff;
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice {
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          color: #fff;
          border: none;
          border-radius: 10px;
          padding: 6px 14px;
          margin: 4px;
          font-size: 0.875rem;
          font-weight: 500;
          letter-spacing: 0.01em;
          box-shadow: 0 2px 4px rgba(37, 99, 235, 0.15);
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s ease;
      }

      .select2-container--default .select2-selection--multiple .select2-selection__choice:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
          background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      }

      .select2-dropdown {
          background: rgba(255, 255, 255, 0.98);
          border: none;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
          backdrop-filter: blur(10px);
          margin-top: 4px;
          animation: dropdownFade 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .select2-container--default .select2-results__option {
          padding: 12px 16px;
          transition: all 0.15s ease;
          font-size: 0.925rem;
          color: #1e293b;
      }

      .select2-container--default .select2-results__option--highlighted[aria-selected] {
          background: rgba(59, 130, 246, 0.08);
          color: #2563eb;
      }

      .select2-container--default .select2-search--inline .select2-search__field {
          font-size: 0.95rem;
          padding: 12px 8px;
          margin-top: 6px;
          font-weight: 400;
          color: #1e293b;
      }

      /* Quick Filters Select */
      .metric-filter {
          background: rgba(255, 255, 255, 0.8);
          border: 1px solid rgba(148, 163, 184, 0.2);
          border-radius: 12px;
          padding: 12px 16px;
          font-size: 0.95rem;
          height: 48px;
          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
          box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
          backdrop-filter: blur(8px);
      }

      .metric-filter:hover {
          background: rgba(255, 255, 255, 0.95);
          border-color: rgba(59, 130, 246, 0.4);
      }

      .metric-filter:focus {
          border-color: rgb(59, 130, 246);
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
          background: #ffffff;
      }

      /* Active Filters */
      .active-filters .badge {
          background: rgba(59, 130, 246, 0.1);
          color: #2563eb;
          border: 1px solid rgba(59, 130, 246, 0.1);
          padding: 8px 16px;
          font-size: 0.875rem;
          font-weight: 500;
          border-radius: 8px;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s ease;
      }

      .active-filters .badge:hover {
          background: rgba(59, 130, 246, 0.15);
          transform: translateY(-1px);
      }

      .active-filters .badge i {
          font-size: 1.1rem;
          opacity: 0.8;
      }

      @keyframes dropdownFade {
          from {
              opacity: 0;
              transform: translateY(-8px) scale(0.98);
          }
          to {
              opacity: 1;
              transform: translateY(0) scale(1);
          }
      }

      /* Form Labels */
      .form-label {
          font-size: 0.875rem;
          font-weight: 600;
          color: #64748b;
          margin-bottom: 0.75rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .form-label i {
          font-size: 1.1rem;
          opacity: 0.8;
      }

      @keyframes dropdownFade {
          from {
              opacity: 0;
              transform: translateY(-8px) scale(0.98);
          }
          to {
              opacity: 1;
              transform: translateY(0) scale(1);
          }
      }

      /* Modern Dashboard Theme */
      .dashboard-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 1.5rem;
          padding: 1.5rem;
          background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);
      }

      .metric-card {
          background: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          box-shadow:
              0 4px 6px -1px rgba(0, 0, 0, 0.1),
              0 2px 4px -1px rgba(0, 0, 0, 0.06);
          transition: transform 0.2s ease;
      }

      .metric-card:hover {
          transform: translateY(-2px);
      }

      .controls-section {
          background: white;
          padding: 1rem;
          border-radius: 1rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .select2-container {
          min-width: 200px;
      }

      .trading-activity .card,
      .performance-comparison .card {
          border: none;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
          transition: transform 0.2s ease;
      }

      .trading-activity .card:hover,
      .performance-comparison .card:hover {
          transform: translateY(-2px);
      }

      .trade-analysis .card-body {
          padding: 1.5rem;
      }

      .export-buttons .btn {
          transition: all 0.2s ease;
      }

      .export-buttons .btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <div class="page-pretitle">Backtest Results</div>
              <h2 class="page-title">
                {{ strategy_name }} - Multi-Symbol Analysis
              </h2>
            </div>
            <!-- Page title actions -->
            <div class="col-auto ms-auto d-print-none">
              <div class="btn-list">
                <span class="d-none d-sm-inline">
                  <a href="#" class="btn btn-white" onclick="window.print()">
                    <i class="ti ti-printer"></i>
                    Export PDF
                  </a>
                </span>
                <a
                  href="#"
                  class="btn btn-primary d-none d-sm-inline-block"
                  data-bs-toggle="modal"
                  data-bs-target="#modal-report"
                >
                  <i class="ti ti-chart-bar"></i>
                  View Full Report
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <!-- Overview Cards -->
          <div class="row g-3 mb-4">
            {% for metric in overall_metrics %}
            <div class="col-sm-6 col-lg-3">
              <div class="card metric-overview">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon">
                      <i
                        class="fas fa-{{ 'chart-line' if 'return' in metric.title.lower() 
                                                        else 'chart-bar' if 'sharpe' in metric.title.lower() 
                                                        else 'chart-area' }}"
                      ></i>
                    </div>
                    <div class="subheader">{{ metric.title }}</div>
                  </div>
                  <div
                    class="h1 mb-3 {% if metric.color %}{{ metric.color }}{% endif %}"
                  >
                    {{ metric.value }}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Main Analysis Grid -->
          <div class="analysis-grid">
            <!-- Portfolio Performance -->
            <div class="chart-card">
              <div class="card-header">
                <h3><i class="fas fa-chart-line"></i> Portfolio Performance</h3>
              </div>
              <div id="portfolioEquity" class="chart-container"></div>
            </div>

            <!-- Correlation Matrix -->
            <div class="chart-card">
              <div class="card-header">
                <h3>
                  <i class="fas fa-project-diagram"></i> Symbol Correlation
                  Matrix
                </h3>
              </div>
              <div id="correlationMatrix" class="chart-container"></div>
            </div>
          </div>

          <!-- Performance Comparison -->
          <div class="performance-comparison mb-4">
            <div class="card">
              <div class="card-header">
                <h3>
                  <i class="fas fa-chart-line me-2"></i>Performance Comparison
                </h3>
              </div>
              <div class="card-body">
                <div
                  id="performanceComparisonChart"
                  style="height: 400px"
                ></div>
              </div>
            </div>
          </div>

          <!-- Trading Activity Heatmap -->
          <div class="trading-activity mb-4">
            <div class="card">
              <div class="card-header">
                <h3>
                  <i class="fas fa-calendar-alt me-2"></i>Trading Activity
                  Heatmap
                </h3>
              </div>
              <div class="card-body">
                <div id="tradingHeatmap" style="height: 350px"></div>
              </div>
            </div>
          </div>

          <!-- Symbol Filters -->
          <div class="card filter-card" data-aos="fade-up">
            <div class="card-body p-4">
              <div class="row g-4">
                <!-- Symbol Search -->
                <div class="col-lg-8">
                  <label class="form-label d-flex align-items-center gap-2">
                    <i class="ti ti-search text-muted"></i>
                    <span>Symbol Search</span>
                  </label>
                  <div class="symbol-search-wrapper">
                    <select class="form-select symbol-selector" multiple>
                      {% for symbol in symbol_results.keys() %}
                      <option value="{{ symbol }}">{{ symbol }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <!-- Quick Filters -->
                <div class="col-lg-4">
                  <label class="form-label d-flex align-items-center gap-2">
                    <i class="ti ti-adjustments text-muted"></i>
                    <span>Quick Filters</span>
                  </label>
                  <select class="form-select metric-filter">
                    <option value="">All Symbols</option>
                    <option value="profitable">Profitable Only</option>
                    <option value="sharpe">High Sharpe Ratio (>1)</option>
                    <option value="drawdown">Low Drawdown (<20%)</option>
                    <option value="winrate">High Win Rate (>50%)</option>
                  </select>
                </div>
              </div>

              <!-- Active Filters -->
              <div class="mt-4 active-filters d-flex flex-wrap gap-2"></div>
            </div>
          </div>

          <!-- Symbol-specific Sections -->
          {% for symbol, results in symbol_results.items() %}
          <div class="symbol-section" id="symbol-{{ symbol }}">
            <div class="symbol-header mb-4">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="page-pretitle">Symbol Analysis</div>
                  <h2 class="page-title d-flex align-items-center">
                    {{ symbol }}
                    <span
                      class="badge ms-3 {% if results.total_return >= 0 %}badge-success{% else %}badge-danger{% endif %}"
                    >
                      {{ "{:.2f}%".format(results.total_return) }}
                    </span>
                  </h2>
                </div>
              </div>
            </div>

            <!-- Metrics Dashboard -->
            <div class="metrics-dashboard">
              <!-- Performance Overview -->
              <div class="metric-card-large" data-aos="fade-up">
                <div class="metric-header">
                  <h3>
                    <i class="fas fa-chart-line"></i> Performance Overview
                  </h3>
                </div>
                <div class="metric-content">
                  <div class="trading-stats-grid">
                    {% for metric in results.metrics['Performance Metrics'] %}
                    <div class="stat-box">
                      <div class="stat-icon">
                        <i
                          class="fas fa-{{ 'arrow-trend-up' if 'return' in metric.title.lower() else 'chart-line' if 'alpha' in metric.title.lower() or 'beta' in metric.title.lower() else 'calculator' }}"
                        ></i>
                      </div>
                      <div class="stat-info">
                        <div class="stat-label">{{ metric.title }}</div>
                        <div
                          class="stat-value"
                          data-metric="{{ metric.title|lower|replace(' ', '_') }}"
                        >
                          {{ metric.value }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <!-- Risk Analysis -->
              <div
                class="metric-card-medium"
                data-aos="fade-up"
                data-aos-delay="100"
              >
                <div class="metric-header">
                  <h3><i class="fas fa-shield-alt"></i> Risk Analysis</h3>
                </div>
                <div class="metric-content">
                  <div class="trading-stats-grid">
                    {% for metric in results.metrics['Risk Metrics'] %}
                    <div class="stat-box">
                      <div class="stat-icon">
                        <i
                          class="fas fa-{{ 'chart-area' if 'drawdown' in metric.title.lower() else 'chart-line' if 'volatility' in metric.title.lower() else 'shield' }}"
                        ></i>
                      </div>
                      <div class="stat-info">
                        <div class="stat-label">{{ metric.title }}</div>
                        <div
                          class="stat-value"
                          data-metric="{{ metric.title|lower|replace(' ', '_') }}"
                        >
                          {{ metric.value }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <!-- Risk Metrics Radar -->
                  <div class="chart-card" data-aos="fade-up">
                    <div class="card-header">
                      <h3>
                        <i class="ti ti-radar"></i> {{ symbol }} Risk Metrics
                        Analysis
                      </h3>
                    </div>
                    <div class="chart-container">
                      <canvas
                        id="riskRadar-{{ symbol|replace('.', '-') }}"
                        height="400"
                      ></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Trading Statistics -->
              <div
                class="metric-card-medium"
                data-aos="fade-up"
                data-aos-delay="200"
              >
                <div class="metric-header">
                  <h3><i class="fas fa-calculator"></i> Trading Statistics</h3>
                </div>
                <div class="metric-content">
                  <div class="trading-stats-grid">
                    {% for metric in results.metrics['Trading Statistics'] %}
                    <div class="stat-box">
                      <div class="stat-icon">
                        <i
                          class="fas fa-{{ 'arrow-up' if 'win' in metric.title.lower() else 'arrow-down' if 'loss' in metric.title.lower() else 'chart-bar' }}"
                        ></i>
                      </div>
                      <div class="stat-info">
                        <div class="stat-label">{{ metric.title }}</div>
                        <div
                          class="stat-value"
                          data-metric="{{ metric.title|lower|replace(' ', '_') }}"
                        >
                          {{ metric.value }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
              <div class="chart-container" data-aos="fade-up">
                <div
                  id="equity-{{ symbol|replace('.', '-') }}"
                  style="height: 400px"
                ></div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div
                    class="chart-container"
                    data-aos="fade-up"
                    data-aos-delay="100"
                  >
                    <div
                      id="drawdown-{{ symbol|replace('.', '-') }}"
                      style="height: 300px"
                    ></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div
                    class="chart-container"
                    data-aos="fade-up"
                    data-aos-delay="200"
                  >
                    <div
                      id="monthly-returns-{{ symbol|replace('.', '-') }}"
                      style="height: 300px"
                    ></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Trade Analysis Section -->
            <div class="section mb-5">
              <h3><i class="fas fa-exchange-alt"></i>Trade History</h3>
              <!-- Price Chart with Trade Points -->
              <div class="chart-container">
                <div
                  id="price-{{ symbol|replace('.', '-') }}"
                  style="height: 400px"
                ></div>
              </div>
              <!-- Trades Table -->
              <div class="trades-table">
                <div
                  id="tradesGrid-{{ symbol|replace('.', '-') }}"
                  class="ag-theme-alpine"
                  style="height: 500px; width: 100%"
                ></div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      // Helper function to sanitize symbol ID for CSS selector
      function sanitizeSymbolId(symbol) {
          return symbol.replace(/[.]/g, '-');
      }

      // Enhanced Highcharts theme
      Highcharts.setOptions({
          chart: {
              style: {
                  fontFamily: 'Inter, sans-serif'
              }
          },
          accessibility: {
              enabled: true,
              description: 'Trading backtest results visualization showing performance metrics and trade history.',
              announceNewData: {
                  enabled: true
              }
          }
      });

      // Combined Portfolio Equity Curve
      Highcharts.stockChart('portfolioEquity', {
          chart: {
              type: 'area',
              style: { fontFamily: 'Inter, sans-serif' }
          },
          title: { text: 'Combined Portfolio Performance' },
          xAxis: { type: 'datetime' },
          yAxis: {
              title: { text: 'Portfolio Value ($)' },
              labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
          },
          series: [{
              name: 'Portfolio Value',
              data: {{ portfolio_equity_data|tojson }},
              color: '#2c3e50',
              fillColor: {
                  linearGradient: {
                      x1: 0, y1: 0, x2: 0, y2: 1
                  },
                  stops: [
                      [0, Highcharts.color('#2c3e50').setOpacity(0.3).get('rgba')],
                      [1, Highcharts.color('#2c3e50').setOpacity(0).get('rgba')]
                  ]
              }
          }],
          tooltip: {
              valuePrefix: '$',
              valueDecimals: 2
          }
      });

      // Initialize correlation matrix
      $(document).ready(function() {
          Highcharts.chart('correlationMatrix', {
              chart: {
                  type: 'heatmap',
                  height: 400
              },
              title: { text: null },
              xAxis: {
                  categories: {{ correlation_symbols|tojson }},
                  labels: { rotation: -45 }
              },
              yAxis: {
                  categories: {{ correlation_symbols|tojson }},
                  title: null
              },
              colorAxis: {
                  min: -1,
                  max: 1,
                  stops: [
                      [0, '#ff1744'],    // Red for negative correlation
                      [0.5, '#f8f9fa'],  // Light gray for no correlation
                      [1, '#00c853']     // Green for positive correlation
                  ]
              },
              series: [{
                  name: 'Correlation',
                  data: {{ correlation_data|tojson }},
                  dataLabels: {
                      enabled: true,
                      color: '#2c3e50',
                      format: '{point.value:.2f}'
                  }
              }]
          });

          // Initialize symbol-specific charts
          {% for symbol, results in symbol_results.items() %}
              // Equity Curve
              Highcharts.chart('equity-{{ symbol|replace('.', '-') }}', {
                  chart: { type: 'area' },
                  title: { text: '{{ symbol }} Performance Comparison' },
                  xAxis: { type: 'datetime' },
                  yAxis: {
                      title: { text: 'Value ($)' },
                      labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                  },
                  series: [{
                      name: 'Strategy',
                      data: {{ results.equity_curve|tojson }},
                      color: '#3498db',
                      fillColor: {
                          linearGradient: {
                              x1: 0, y1: 0, x2: 0, y2: 1
                          },
                          stops: [
                              [0, Highcharts.color('#3498db').setOpacity(0.3).get('rgba')],
                              [1, Highcharts.color('#3498db').setOpacity(0).get('rgba')]
                          ]
                      },
                      zIndex: 2
                  },
                  {
                      name: 'Buy & Hold',
                      data: {{ results.benchmark_curve|tojson }},
                      type: 'line',  // Changed from area to line
                      color: '#34495e',  // Darker color for better contrast
                      lineWidth: 2,
                      dashStyle: 'ShortDot',  // More subtle dash style
                      marker: {
                          enabled: false
                      },
                      states: {
                          hover: {
                              lineWidth: 3
                          }
                      },
                      zIndex: 1
                  }],
                  tooltip: {
                      valuePrefix: '$',
                      valueDecimals: 2,
                      shared: true  // Show both values in tooltip
                  },
                  legend: {
                      enabled: true,
                      align: 'right',
                      verticalAlign: 'top',
                      layout: 'vertical',
                      backgroundColor: 'rgba(255, 255, 255, 0.9)',
                      borderRadius: 8,
                      padding: 12,
                      shadow: false
                  }
              });

              // Drawdown Chart
              Highcharts.chart('drawdown-{{ symbol|replace('.', '-') }}', {
                  chart: { type: 'area' },
                  title: { text: '{{ symbol }} Drawdown' },
                  xAxis: { type: 'datetime' },
                  yAxis: {
                      title: { text: 'Drawdown (%)' },
                      labels: { format: '{value}%' }
                  },
                  series: [{
                      name: 'Drawdown',
                      data: {{ results.drawdown|tojson }},
                      color: '#e74c3c',
                      fillColor: {
                          linearGradient: {
                              x1: 0, y1: 0, x2: 0, y2: 1
                          },
                          stops: [
                              [0, Highcharts.color('#e74c3c').setOpacity(0.3).get('rgba')],
                              [1, Highcharts.color('#e74c3c').setOpacity(0).get('rgba')]
                          ]
                      }
                  }],
                  tooltip: {
                      valueSuffix: '%',
                      valueDecimals: 2
                  }
              });

              // Monthly Returns
              Highcharts.chart('monthly-returns-{{ symbol|replace('.', '-') }}', {
                  chart: { type: 'column' },
                  title: { text: '{{ symbol }} Monthly Returns' },
                  xAxis: { type: 'datetime' },
                  yAxis: {
                      title: { text: 'Return (%)' },
                      labels: { format: '{value}%' }
                  },
                  series: [{
                      name: 'Monthly Return',
                      data: {{ results.monthly_returns|tojson }},
                      color: '#2ecc71',
                      negativeColor: '#e74c3c'
                  }],
                  tooltip: {
                      valueSuffix: '%',
                      valueDecimals: 2
                  }
              });


              // Price Chart with Trade Points
              Highcharts.stockChart('price-{{ symbol|replace('.', '-') }}', {
                  chart: {
                      type: 'line',
                      style: { fontFamily: 'Inter, sans-serif' }
                  },
                  title: { text: '{{ symbol }} Price Chart with Trades' },
                  yAxis: {
                      title: { text: 'Price ($)' },
                      labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                  },
                  series: [{
                      name: 'Price',
                      data: {{ results.price_data|tojson }},
                      color: '#2c3e50',
                      lineWidth: 2,
                      id: 'price'
                  }, {
                      type: 'scatter',
                      name: 'Trade Points',
                      data: {{ results.trade_annotations|tojson|safe }}.map(function(point) {
                          return {
                              x: point.x,
                              y: point.y,
                              marker: {
                                  symbol: point.title === '' ? 'triangle' : 'triangle-down',
                                  fillColor: point.title === '' ? '#00c853' : '#ff1744',
                                  lineColor: point.title === '' ? '#00c853' : '#ff1744',
                                  lineWidth: 1,
                                  radius: 8
                              },
                              tooltip: point.text
                          };
                      })
                  }],
                  tooltip: {
                      shared: true,
                      split: false,
                      valuePrefix: '$',
                      valueDecimals: 2,
                      // Add formatter to handle both price and trade points
                      formatter: function() {
                          let s = '<b>' + Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '</b>';

                          this.points.forEach(function(point) {
                              if (point.series.name === 'Price') {
                                  s += '<br/>Price: $' + point.y.toFixed(2);
                              } else if (point.series.name === 'Trade Points') {
                                  s += '<br/>' + (point.point.tooltip || '');
                              }
                          });

                          return s;
                      }
                  },
                  rangeSelector: {
                      enabled: true,
                      buttons: [{
                          type: 'day',
                          count: 7,
                          text: '1w'
                      }, {
                          type: 'month',
                          count: 1,
                          text: '1m'
                      }, {
                          type: 'month',
                          count: 3,
                          text: '3m'
                      }, {
                          type: 'month',
                          count: 6,
                          text: '6m'
                      }, {
                          type: 'year',
                          count: 1,
                          text: '1y'
                      }, {
                          type: 'all',
                          text: 'All'
                      }],
                      selected: 4
                  },
                  navigator: {
                      enabled: true
                  }
              });

              // Initialize Trades Grid
              try {
                  const symbolId = sanitizeSymbolId('{{ symbol }}');
                  console.log('Initializing grid for symbol:', symbolId);

                  const gridOptions = {
                      columnDefs: [
                          {
                              field: 'timestamp',
                              headerName: 'Date/Time',
                              sort: 'desc',
                              sortable: true,
                              filter: true
                          },
                          {
                              field: 'type',
                              headerName: 'Type',
                              cellRenderer: params => {
                                  return `<span class="${params.value.toLowerCase() === 'buy' ? 'positive' : 'negative'}">${params.value}</span>`;
                              }
                          },
                          {
                              field: 'price',
                              headerName: 'Price',
                              valueFormatter: params => '$' + params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                          },
                          { field: 'quantity', headerName: 'Quantity' },
                          {
                              field: 'cost',
                              headerName: 'Cost',
                              valueFormatter: params => '$' + Math.abs(params.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                          },
                          {
                              field: 'commission',
                              headerName: 'Commission',
                              valueFormatter: params => '$' + params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                          },
                          {
                              field: 'pnl',
                              headerName: 'P&L',
                              cellRenderer: params => {
                                  const value = params.value;
                                  const formattedValue = '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                  return `<span class="${value >= 0 ? 'positive' : 'negative'}">${formattedValue}</span>`;
                              }
                          }
                      ],
                      rowData: {{ results.trades|tojson|safe }},
                      defaultColDef: {
                          sortable: true,
                          filter: true,
                          resizable: true,
                          flex: 1
                      },
                      domLayout: 'autoHeight',
                      animateRows: true,
                      enableCellTextSelection: true,
                      pagination: true,
                      paginationPageSize: 10
                  };

                  const gridDiv = document.querySelector(`#tradesGrid-${symbolId}`);
                  if (!gridDiv) {
                      console.error('Grid container not found:', `#tradesGrid-${symbolId}`);
                      return;
                  }

                  const gridApi = agGrid.createGrid(gridDiv, gridOptions);
              } catch (error) {
                  console.error('Error initializing grid:', error);
              }
          {% endfor %}
      });

      // Initialize AOS
      AOS.init({
          duration: 800,
          once: true,
          offset: 100
      });

      document.addEventListener('DOMContentLoaded', function() {
          // Initialize Tabler UI
          window.tabler = {
              colors: {
                  blue: '#206bc4',
                  green: '#2fb344',
                  red: '#d63939',
              }
          };

          // Handle lazy loading of charts
          const tabEls = document.querySelectorAll('a[data-bs-toggle="tab"]');
          tabEls.forEach(tabEl => {
              tabEl.addEventListener('shown.bs.tab', event => {
                  const targetId = event.target.getAttribute('href');
                  const chartContainer = document.querySelector(`${targetId} [id^="chart-"]`);
                  if (chartContainer && !chartContainer.hasAttribute('data-loaded')) {
                      // Initialize chart here
                      chartContainer.setAttribute('data-loaded', 'true');
                  }
              });
          });

              // Initialize Risk Radar Charts
          {% for symbol, results in symbol_results.items() %}
              initializeRiskRadar('{{ symbol }}', {{ results.metrics|tojson }});
          {% endfor %}

          // Initialize Select2
          $('.symbol-selector').select2({
              theme: 'default',
              placeholder: 'Type to search symbols...',
              allowClear: true,
              width: '100%',
              templateResult: formatSymbolOption,
              templateSelection: formatSymbolOption,
              escapeMarkup: function(markup) {
                  return markup;
              }
          }).on('change', function() {
              const selectedSymbols = $(this).val();
              showSelectedSymbols(selectedSymbols);
              updateActiveFilters();
          });

          // Initialize metric filter
          $('.metric-filter').on('change', function() {
              filterSymbols();
              updateActiveFilters();
          });

          // Format symbol options with icons
          function formatSymbolOption(option) {
              if (!option.id) return option.text;
              return `<div class="d-flex align-items-center gap-2">
                  <i class="ti ti-chart-candlestick text-primary"></i>
                  <span>${option.text}</span>
              </div>`;
          }

          function filterSymbols() {
              const selectedSymbols = $('.symbol-selector').val() || [];
              const metricFilter = $('.metric-filter').val();

              $('.symbol-section').each(function() {
                  const section = $(this);
                  const symbol = section.attr('id').replace('symbol-', '');
                  let visible = true;

                  // Symbol filter
                  if (selectedSymbols.length > 0) {
                      visible = selectedSymbols.includes(symbol);
                  }

                  // Metric filters
                  if (visible && metricFilter) {
                      const metrics = {
                          total_return: parseFloat(section.find('[data-metric="total_return"]').text().replace('%', '')),
                          sharpe_ratio: parseFloat(section.find('[data-metric="sharpe_ratio"]').text()),
                          max_drawdown: parseFloat(section.find('[data-metric="max_drawdown"]').text().replace('%', '')),
                          win_rate: parseFloat(section.find('[data-metric="win_rate"]').text().replace('%', ''))
                      };

                      switch(metricFilter) {
                          case 'profitable':
                              visible = metrics.total_return > 0;
                              break;
                          case 'sharpe':
                              visible = metrics.sharpe_ratio > 1;
                              break;
                          case 'drawdown':
                              visible = Math.abs(metrics.max_drawdown) < 20;
                              break;
                          case 'winrate':
                              visible = metrics.win_rate > 50;
                              break;
                      }
                  }

                  if (visible) {
                      section.fadeIn(300);
                  } else {
                      section.fadeOut(300);
                  }
              });

              // Redraw charts for visible sections
              setTimeout(() => {
                  $('.symbol-section:visible').each(function() {
                      const symbol = $(this).attr('id').replace('symbol-', '');
                      const charts = [
                          `equity-${symbol}`,
                          `drawdown-${symbol}`,
                          `monthly-returns-${symbol}`,
                          `price-${symbol}`
                      ];

                      charts.forEach(chartId => {
                          const chart = Highcharts.charts.find(c => c && c.renderTo.id === chartId);
                          if (chart) {
                              chart.reflow();
                          }
                      });
                  });
              }, 350);
          }

          function updateActiveFilters() {
              const container = $('.active-filters');
              container.empty();

              const selectedSymbols = $('.symbol-selector').val();
              const metricFilter = $('.metric-filter').val();

              if (selectedSymbols && selectedSymbols.length) {
                  container.append(`
                      <span class="badge bg-primary me-2">
                          <i class="ti ti-chart-candlestick me-1"></i>
                          ${selectedSymbols.length} symbols selected
                      </span>
                  `);
              }

              if (metricFilter) {
                  container.append(`
                      <span class="badge bg-success me-2">
                          <i class="ti ti-adjustments me-1"></i>
                          ${$('.metric-filter option:selected').text()}
                      </span>
                  `);
              }
          }
      });

      function showSelectedSymbols(selectedSymbols) {
          $('.symbol-section').each(function() {
              const section = $(this);
              const symbol = section.attr('id').replace('symbol-', '');

              if (!selectedSymbols || selectedSymbols.length === 0) {
                  // If no symbols selected, show all
                  section.show();
                  return;
              }

              if (Array.isArray(selectedSymbols)) {
                  section.toggle(selectedSymbols.includes(symbol));
              } else {
                  section.toggle(selectedSymbols === symbol);
              }
          });

          // Trigger resize event for charts
          window.dispatchEvent(new Event('resize'));
      }

      function initializeRiskRadar(symbol, metrics) {
          const ctx = document.getElementById(`riskRadar-${symbol.replace('.', '-')}`).getContext('2d');

          // Helper function to find metric value by title
          function getMetricValue(metricGroup, titlePattern) {
              const metric = metrics[metricGroup].find(m => m.title.toLowerCase().includes(titlePattern.toLowerCase()));
              return metric ? parseFloat(metric.value) : 0;
          }

          const data = {
              labels: [
                  'Sharpe Ratio',
                  'Sortino Ratio',
                  'Max Drawdown',
                  'Win Rate',
                  'Profit Factor',
                  'Recovery Factor'
              ],
              datasets: [{
                  label: symbol,
                  data: [
                      getMetricValue('Risk Metrics', 'Sharpe'),
                      getMetricValue('Risk Metrics', 'Sortino'),
                      getMetricValue('Risk Metrics', 'Max Drawdown') * -1,
                      getMetricValue('Trading Statistics', 'Win Rate'),
                      getMetricValue('Trading Statistics', 'Profit Factor'),
                      getMetricValue('Risk Metrics', 'Recovery')
                  ],
                  fill: true,
                  backgroundColor: 'rgba(59, 130, 246, 0.2)',
                  borderColor: 'rgb(59, 130, 246)',
                  pointBackgroundColor: 'rgb(59, 130, 246)',
                  pointBorderColor: '#fff',
                  pointHoverBackgroundColor: '#fff',
                  pointHoverBorderColor: 'rgb(59, 130, 246)'
              }]
          };

          new Chart(ctx, {
              type: 'radar',
              data: data,
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      r: {
                          angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                          grid: { color: 'rgba(0, 0, 0, 0.1)' },
                          pointLabels: {
                              font: { size: 12, family: 'Inter' }
                          },
                          ticks: {
                              backdropColor: 'transparent',
                              font: { size: 10 }
                          }
                      }
                  },
                  plugins: {
                      legend: { position: 'top' },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                              }
                          }
                      }
                  }
              }
          });
      }
      // Initialize Select2 for symbol filtering
      $('.symbol-filter').select2({
          placeholder: "Filter Symbols",
          allowClear: true
      });

      // Performance Comparison Chart
      function initializePerformanceComparison(symbolResults) {
          const series = Object.entries(symbolResults).map(([symbol, data]) => ({
              name: symbol,
              data: data.equity_curve.map(point => [point[0], point[1] / data.equity_curve[0][1] * 100 - 100])
          }));

          Highcharts.stockChart('performanceComparisonChart', {
              title: { text: 'Normalized Performance Comparison' },
              yAxis: {
                  labels: { format: '{value}%' },
                  title: { text: 'Return (%)' }
              },
              series: series,
              tooltip: {
                  pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y:.2f}%</b><br/>',
                  valueDecimals: 2
              }
          });
      }

      // Trading Activity Heatmap
      function initializeTradingHeatmap(symbolResults) {
          // Initialize 2D array for day/hour combinations
          const tradeCount = Array(7).fill(0).map(() => Array(24).fill(0));

          // Count trades for each day/hour combination
          Object.entries(symbolResults).forEach(([symbol, data]) => {
              data.trades.forEach(trade => {
                  const date = new Date(trade.timestamp);
                  const dayOfWeek = date.getDay(); // 0-6
                  const hour = date.getHours(); // 0-23
                  tradeCount[dayOfWeek][hour]++;
              });
          });

          // Convert to Highcharts format
          const tradeData = [];
          for (let day = 0; day < 7; day++) {
              for (let hour = 0; hour < 24; hour++) {
                  tradeData.push([day, hour, tradeCount[day][hour]]);
              }
          }

          Highcharts.chart('tradingHeatmap', {
              chart: {
                  type: 'heatmap',
                  height: 350, // Increased height
                  marginTop: 40,
                  marginBottom: 80,
                  marginRight: 120 // More space for legend
              },
              title: {
                  text: 'Trading Activity Distribution',
                  style: {
                      fontSize: '16px',
                      fontWeight: '500'
                  }
              },
              xAxis: {
                  categories: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                  title: {
                      text: 'Day of Week',
                      style: {
                          fontSize: '13px'
                      }
                  },
                  labels: {
                      style: {
                          fontSize: '12px'
                      }
                  }
              },
              yAxis: {
                  categories: Array.from({length: 24}, (_, i) =>
                      `${String(i).padStart(2, '0')}:00`
                  ),
                  title: {
                      text: 'Hour of Day',
                      style: {
                          fontSize: '13px'
                      }
                  },
                  labels: {
                      style: {
                          fontSize: '11px'
                      }
                  },
                  reversed: true
              },
              colorAxis: {
                  min: 0,
                  minColor: '#FFFFFF',
                  maxColor: '#206bc4',
                  labels: {
                      style: {
                          fontSize: '11px'
                      }
                  }
              },
              legend: {
                  align: 'right',
                  layout: 'vertical',
                  margin: 0,
                  verticalAlign: 'top',
                  y: 25,
                  symbolHeight: 280,
                  title: {
                      text: 'Trades',
                      style: {
                          fontSize: '12px'
                      }
                  }
              },
              tooltip: {
                  formatter: function () {
                      return '<b>' + this.series.xAxis.categories[this.point.x] + '</b><br/>' +
                          '<b>' + this.series.yAxis.categories[this.point.y] + '</b><br/>' +
                          '<b>Trades: </b>' + this.point.value;
                  }
              },
              series: [{
                  name: 'Trading Activity',
                  borderWidth: 1,
                  data: tradeData,
                  dataLabels: {
                      enabled: true,
                      color: '#000000',
                      style: {
                          fontSize: '10px',
                          textOutline: 'none',
                          fontWeight: '400'
                      },
                      formatter: function() {
                          return this.point.value > 0 ? this.point.value : '';
                      }
                  }
              }]
          });
      }

      // Initialize all charts
      document.addEventListener('DOMContentLoaded', function() {
          initializePerformanceComparison({{ symbol_results|tojson }});
          initializeTradingHeatmap({{ symbol_results|tojson }});
      });
    </script>
  </body>
</html>
